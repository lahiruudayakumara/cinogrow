"""
ML Training Results Models
Stores machine learning model training results and metadata in the database
"""

from sqlmodel import SQLModel, Field, Column
from typing import Optional, Dict, Any
from datetime import datetime
from sqlalchemy import JSON


class MLTrainingRun(SQLModel, table=True):
    """
    Stores information about ML model training runs
    """
    __tablename__ = "ml_training_runs"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    training_id: str = Field(unique=True, index=True, description="Unique training run identifier")
    
    # Model information
    model_name: str = Field(description="Name of the model (e.g., 'fertilizer_cnn_real', 'fertilizer_rf_real')")
    model_type: str = Field(description="Type of model (CNN, RandomForest, etc.)")
    model_version: str = Field(description="Model version/timestamp")
    
    # Dataset information
    total_images: int = Field(description="Total number of images used")
    train_samples: int = Field(description="Number of training samples")
    test_samples: int = Field(description="Number of test samples")
    class_distribution: Dict[str, int] = Field(default_factory=dict, sa_column=Column(JSON), 
                                               description="Number of samples per class")
    
    # Training parameters
    training_params: Dict[str, Any] = Field(default_factory=dict, sa_column=Column(JSON),
                                           description="Training hyperparameters and configuration")
    
    # Performance metrics
    accuracy: float = Field(description="Model accuracy on test set")
    loss: Optional[float] = Field(default=None, description="Model loss (for neural networks)")
    precision: Optional[float] = Field(default=None, description="Precision score")
    recall: Optional[float] = Field(default=None, description="Recall score")
    f1_score: Optional[float] = Field(default=None, description="F1 score")
    
    # Detailed metrics
    classification_report: Optional[str] = Field(default=None, description="Full classification report")
    confusion_matrix: Optional[Dict[str, Any]] = Field(default_factory=dict, sa_column=Column(JSON),
                                                       description="Confusion matrix")
    class_metrics: Optional[Dict[str, Any]] = Field(default_factory=dict, sa_column=Column(JSON),
                                                    description="Per-class performance metrics")
    
    # Training history (for neural networks)
    training_history: Optional[Dict[str, Any]] = Field(default_factory=dict, sa_column=Column(JSON),
                                                       description="Training history (loss, accuracy per epoch)")
    
    # File paths
    model_file_path: str = Field(description="Path to saved model file")
    scaler_file_path: Optional[str] = Field(default=None, description="Path to scaler file (for traditional ML)")
    recommendations_file_path: Optional[str] = Field(default=None, description="Path to recommendations JSON")
    summary_file_path: Optional[str] = Field(default=None, description="Path to training summary JSON")
    
    # Training metadata
    training_duration_seconds: float = Field(description="Total training time in seconds")
    epochs_completed: Optional[int] = Field(default=None, description="Number of epochs completed (for neural networks)")
    early_stopping_epoch: Optional[int] = Field(default=None, description="Epoch where early stopping occurred")
    
    # Status and timestamps
    status: str = Field(default="completed", description="Training status (completed, failed, in_progress)")
    is_active_model: bool = Field(default=False, description="Whether this is the currently active model")
    created_at: datetime = Field(default_factory=datetime.utcnow, description="Training completion timestamp")
    created_by: Optional[str] = Field(default=None, description="User or system that initiated training")
    
    # Additional notes
    notes: Optional[str] = Field(default=None, description="Additional notes about this training run")
    dataset_source: Optional[str] = Field(default=None, description="Source of training dataset")


class FertilizerRecommendation(SQLModel, table=True):
    """
    Stores fertilizer recommendations generated by ML models
    """
    __tablename__ = "fertilizer_recommendations_db"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    
    # Deficiency type
    deficiency_type: str = Field(index=True, description="Type of deficiency (healthy, nitrogen_deficiency, etc.)")
    
    # Status and symptoms
    status: str = Field(description="Health status description")
    symptoms: Optional[Dict[str, Any]] = Field(default_factory=dict, sa_column=Column(JSON),
                                               description="List of symptoms")
    
    # Recommendations
    recommended_fertilizers: Dict[str, Any] = Field(default_factory=dict, sa_column=Column(JSON),
                                                   description="List of recommended fertilizers with details")
    organic_alternatives: Optional[Dict[str, Any]] = Field(default_factory=dict, sa_column=Column(JSON),
                                                           description="Organic fertilizer alternatives")
    additional_tips: Optional[Dict[str, Any]] = Field(default_factory=dict, sa_column=Column(JSON),
                                                      description="Additional care tips")
    
    # Recovery information
    expected_recovery: Optional[str] = Field(default=None, description="Expected recovery timeline")
    
    # Metadata
    created_at: datetime = Field(default_factory=datetime.utcnow, description="When this recommendation was created")
    updated_at: datetime = Field(default_factory=datetime.utcnow, description="Last update timestamp")
    source_training_run_id: Optional[str] = Field(default=None, description="Training run that generated this")
    is_active: bool = Field(default=True, description="Whether this recommendation is currently active")
    version: str = Field(default="1.0", description="Recommendation version")


# Utility functions

def generate_training_id() -> str:
    """Generate unique training run ID"""
    import uuid
    timestamp = int(datetime.utcnow().timestamp() * 1000)
    random_part = str(uuid.uuid4())[:8]
    return f"training_{timestamp}_{random_part}"
